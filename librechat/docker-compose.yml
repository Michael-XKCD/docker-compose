# Based on LibreChat official docker-compose
#
# Preflight:
# mkdir -p "${APPDATA_PATH}/librechat"/{images,uploads,logs,mongodb,meilisearch,vectordb,searxng}

networks:
  backend:
    internal: true
  egress:
    internal: false
  proxynet:
    external: true

services:
  librechat-app:
    container_name: librechat_app
    image: ghcr.io/danny-avila/librechat-dev:${LIBRECHAT_VERSION:-latest}
    restart: unless-stopped
    depends_on:
      - mongodb
      - meilisearch
      - rag_api
    networks:
      - proxynet
      - egress
      - backend
    user: "99:100"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - HOST=${HOST}
      - PORT=${PORT}
      - MONGO_URI=mongodb://${MONGO_USER}:${MONGO_PWD}@mongodb:27017/LibreChat?authSource=admin
      - DOMAIN_CLIENT=${DOMAIN_CLIENT}
      - DOMAIN_SERVER=${DOMAIN_SERVER}
      - RAG_API_URL=http://rag_api:${RAG_PORT}
      - RAG_PORT=${RAG_PORT}
      - MEILI_HOST=http://meilisearch:7700
      - MEILI_MASTER_KEY=${MEILI_MASTER_KEY}
      - SEARCH=${SEARCH}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - DEBUG_LOGGING=${DEBUG_LOGGING:-false}
      - DEBUG_CONSOLE=${DEBUG_CONSOLE:-true}
      - DEBUG_OPENAI=${DEBUG_OPENAI:-false}
      - DEBUG_PLUGINS=${DEBUG_PLUGINS:-true}
      - CREDS_KEY=${CREDS_KEY}
      - CREDS_IV=${CREDS_IV}
      - APP_TITLE=${APP_TITLE:-LibreChat}
      - HELP_AND_FAQ_URL=${HELP_AND_FAQ_URL:-https://librechat.ai}
      - ALLOW_SHARED_LINKS=${ALLOW_SHARED_LINKS:-false}
      - ALLOW_SHARED_LINKS_PUBLIC=${ALLOW_SHARED_LINKS_PUBLIC:-false}
      - ALLOW_EMAIL_LOGIN=${ALLOW_EMAIL_LOGIN}
      - ALLOW_REGISTRATION=${ALLOW_REGISTRATION}
      - ALLOW_SOCIAL_LOGIN=${ALLOW_SOCIAL_LOGIN}
      - ALLOW_SOCIAL_REGISTRATION=${ALLOW_SOCIAL_REGISTRATION}
      - ALLOW_PASSWORD_RESET=${ALLOW_PASSWORD_RESET}
      - ALLOW_UNVERIFIED_EMAIL_LOGIN=${ALLOW_UNVERIFIED_EMAIL_LOGIN}
      - SESSION_EXPIRY=${SESSION_EXPIRY}
      - REFRESH_TOKEN_EXPIRY=${REFRESH_TOKEN_EXPIRY}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
      - TZ=America/Los_Angeles
    volumes:
      - ${APPDATA_PATH}/librechat/librechat.yaml:/app/librechat.yaml:ro
      - ${APPDATA_PATH}/librechat/images:/app/client/public/images
      - ${APPDATA_PATH}/librechat/uploads:/app/uploads
      - ${APPDATA_PATH}/librechat/logs:/app/api/logs
      - ${APPDATA_PATH}/librechat/logs:/app/logs
      - /etc/localtime:/etc/localtime:ro
    labels:
      net.unraid.docker.webui: http://${UI_URL}
      net.unraid.docker.icon: https://raw.githubusercontent.com/danny-avila/LibreChat/main/client/public/assets/LibreChat.svg

  mongodb:
    container_name: librechat_mongodb
    image: mongo:7.0
    restart: unless-stopped
    user: "99:100"
    networks:
      - backend
    volumes:
      - ${APPDATA_PATH}/librechat/mongodb:/data/db
      - /etc/localtime:/etc/localtime:ro
    command: mongod --auth
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_USER}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_PWD}
    labels:
      net.unraid.docker.icon: https://raw.githubusercontent.com/Flight777/unraid_justworks_templates/main/images/mongodb/mongodb.png

  meilisearch:
    container_name: librechat_meilisearch
    image: getmeili/meilisearch:v1.12.3
    restart: unless-stopped
    user: "99:100"
    networks:
      - backend
    environment:
      - TZ=America/Los_Angeles
      - MEILI_MASTER_KEY=${MEILI_MASTER_KEY}
      - MEILI_NO_ANALYTICS=${MEILI_NO_ANALYTICS:-true}
    volumes:
      - ${APPDATA_PATH}/librechat/meilisearch:/meili_data
      - /etc/localtime:/etc/localtime:ro
    labels:
      net.unraid.docker.icon: https://github.com/meilisearch/meilisearch/raw/main/assets/meilisearch-logo.svg

  vectordb:
    container_name: librechat_vectordb
    image: pgvector/pgvector:0.8.0-pg15-trixie
    restart: unless-stopped
    networks:
      - backend
    environment:
      - POSTGRES_DB=${VECTOR_DB_NAME}
      - POSTGRES_USER=${VECTOR_DB_USER}
      - POSTGRES_PASSWORD=${VECTOR_DB_PASSWORD}
      - TZ=America/Los_Angeles
    volumes:
      - ${APPDATA_PATH}/librechat/vectordb:/var/lib/postgresql/data
      - /etc/localtime:/etc/localtime:ro
    labels:
      net.unraid.docker.icon: https://raw.githubusercontent.com/Flight777/unraid_justworks_templates/main/images/postgres/Postgresql_elephant.png

  rag_api:
    container_name: librechat_rag_api
    image: ghcr.io/danny-avila/librechat-rag-api-dev-lite:${LIBRECHAT_VERSION:-latest}
    restart: unless-stopped
    depends_on:
      - vectordb
    networks:
      - backend
      - egress
    environment:
      - DB_HOST=vectordb
      - POSTGRES_DB=${VECTOR_DB_NAME}
      - POSTGRES_USER=${VECTOR_DB_USER}
      - POSTGRES_PASSWORD=${VECTOR_DB_PASSWORD}
      - TZ=America/Los_Angeles
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - RAG_PORT=${RAG_PORT}
    volumes:
      - /etc/localtime:/etc/localtime:ro
    labels:
      net.unraid.docker.icon: https://raw.githubusercontent.com/danny-avila/LibreChat/main/docs/assets/rag-api-icon.png

  searxng:
    container_name: librechat_searxng
    image: searxng/searxng:latest
    restart: unless-stopped
    networks:
      - backend
      - egress
    environment:
      - SEARXNG_BASE_URL=http://searxng:8080
      - TZ=America/Los_Angeles
    volumes:
      - ${APPDATA_PATH}/librechat/searxng:/etc/searxng:rw
      - /etc/localtime:/etc/localtime:ro
    labels:
      net.unraid.docker.icon: https://raw.githubusercontent.com/searxng/searxng/master/src/brand/searxng-wordmark.svg

  firecrawl-redis:
    container_name: librechat_firecrawl_redis
    image: redis:7-alpine
    restart: unless-stopped
    networks:
      - backend
    labels:
      net.unraid.docker.icon: https://raw.githubusercontent.com/A75G/docker-templates/master/templates/icons/redis.png

  firecrawl-playwright:
    container_name: librechat_firecrawl_playwright
    image: trieve/puppeteer-service-ts:v0.0.6
    restart: unless-stopped
    networks:
      - backend
      - egress
    environment:
      - PORT=3000
    labels:
      net.unraid.docker.icon: https://playwright.dev/img/playwright-logo.svg

  firecrawl:
    container_name: librechat_firecrawl
    image: ghcr.io/firecrawl/firecrawl:latest
    restart: unless-stopped
    depends_on:
      - firecrawl-redis
      - firecrawl-playwright
    networks:
      - backend
      - egress
    ulimits:
      nofile:
        soft: 65535
        hard: 65535
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - REDIS_URL=redis://firecrawl-redis:6379
      - REDIS_RATE_LIMIT_URL=redis://firecrawl-redis:6379
      - PLAYWRIGHT_MICROSERVICE_URL=http://firecrawl-playwright:3000
      - PORT=3002
      - HOST=0.0.0.0
      - NUM_WORKERS_PER_QUEUE=4
      - USE_DB_AUTHENTICATION=false
    command: ["pnpm", "run", "start:production"]
    labels:
      net.unraid.docker.icon: https://www.firecrawl.dev/favicon.ico
